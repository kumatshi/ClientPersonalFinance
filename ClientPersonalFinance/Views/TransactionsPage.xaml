<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:ClientPersonalFinance.Converters"
             x:Class="ClientPersonalFinance.Views.TransactionsPage"
             Title="Транзакции">

    <ContentPage.Resources>
        <converters:BalanceColorConverter x:Key="BalanceColorConverter" />
        <converters:TransactionTypeColorConverter x:Key="TransactionTypeColorConverter" />
        <converters:NotNullConverter x:Key="NotNullConverter" />
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter" />
    </ContentPage.Resources>

    <RefreshView IsRefreshing="{Binding IsBusy}"
                 Command="{Binding RefreshCommand}">

        <ScrollView>
            <VerticalStackLayout Spacing="20" Padding="20">

               
                <Frame IsVisible="{Binding IsAddingTransaction}"
                       BackgroundColor="Black"
                       BorderColor="#4CAF50"
                       Padding="15"
                       CornerRadius="10">
                    <VerticalStackLayout Spacing="10">
                        <Label Text=" Новая транзакция" 
                               FontSize="16" 
                               FontAttributes="Bold"
                               TextColor="#2E7D32"/>

                     
                        <VerticalStackLayout Spacing="5">
                            <Label Text="Сумма *" 
                                   FontSize="14"/>
                            <Entry Text="{Binding TransactionAmount, StringFormat='{0:F2}'}"
                                   Placeholder="0.00"
                                   Keyboard="Numeric"
                                   ClearButtonVisibility="WhileEditing"/>
                        </VerticalStackLayout>

                     
                        <VerticalStackLayout Spacing="5">
                            <Label Text="Описание *" 
                                   FontSize="14"/>
                            <Entry Text="{Binding TransactionDescription}"
                                   Placeholder="На что потратили/получили"
                                   MaxLength="200"
                                   ClearButtonVisibility="WhileEditing"/>
                        </VerticalStackLayout>

                     
                        <VerticalStackLayout Spacing="5">
                            <Label Text="Дата" 
                                   FontSize="14"/>
                            <DatePicker Date="{Binding TransactionDate}"
                                        Format="dd.MM.yyyy"/>
                        </VerticalStackLayout>

                     
                        <VerticalStackLayout Spacing="5">
                            <Label Text="Тип *" 
                                   FontSize="14"/>
                            <Picker Title="Выберите тип"
                                    SelectedIndex="{Binding SelectedTransactionType}">
                                <Picker.Items>
                                    <x:String>Доход</x:String>
                                    <x:String>Расход</x:String>
                                </Picker.Items>
                            </Picker>
                        </VerticalStackLayout>

                    
                        <VerticalStackLayout Spacing="5">
                            <Label Text="Счет *" 
                                   FontSize="14"/>
                            <Picker Title="Выберите счет"
                                    ItemsSource="{Binding Accounts}"
                                    ItemDisplayBinding="{Binding Name}"
                                    SelectedItem="{Binding SelectedAccount}"/>
                        </VerticalStackLayout>

                      
                        <VerticalStackLayout Spacing="5">
                            <Label Text="Категория *" 
                                   FontSize="14"/>
                            <Picker Title="Выберите категорию"
                                    ItemsSource="{Binding FilteredCategories}"
                                    ItemDisplayBinding="{Binding Name}"
                                    SelectedItem="{Binding SelectedCategory}"/>
                        </VerticalStackLayout>

                   
                        <HorizontalStackLayout Spacing="10" HorizontalOptions="Center">
                            <Button Text=" Добавить"
                                    Command="{Binding AddTransactionCommand}"
                                    BackgroundColor="Black"
                                    TextColor="White"
                                    CornerRadius="10"
                                    WidthRequest="120"
                                    IsEnabled="{Binding IsNotBusy}"/>

                            <Button Text=" Отмена"
                                    Command="{Binding CancelAddTransactionCommand}"
                                    BackgroundColor="Black"
                                    TextColor="White"
                                    CornerRadius="10"
                                    WidthRequest="120"/>
                        </HorizontalStackLayout>

                    
                        <Frame IsVisible="False" BackgroundColor="Black" Padding="10">
                            <VerticalStackLayout>
                                <Label Text="Отладка:" FontSize="12" FontAttributes="Bold"/>
                                <Label Text="{Binding NewTransaction.Amount, StringFormat='Сумма: {0}'}" FontSize="10"/>
                                <Label Text="{Binding NewTransaction.Description, StringFormat='Описание: {0}'}" FontSize="10"/>
                                <Label Text="{Binding NewTransaction.Type, StringFormat='Тип: {0}'}" FontSize="10"/>
                                <Label Text="{Binding NewTransaction.CategoryId, StringFormat='Категория ID: {0}'}" FontSize="10"/>
                                <Label Text="{Binding NewTransaction.AccountId, StringFormat='Счет ID: {0}'}" FontSize="10"/>
                            </VerticalStackLayout>
                        </Frame>

                    </VerticalStackLayout>
                </Frame>

         
                <Label Text="{Binding StatusMessage}"
                       FontSize="14"
                       TextColor="Gray"
                       HorizontalOptions="Center"/>

              
                <Frame IsVisible="{Binding Summary, Converter={StaticResource NotNullConverter}}"
                       BackgroundColor="Black" Padding="15" CornerRadius="10">
                    <VerticalStackLayout Spacing="10">
                        <Label Text=" Финансовая сводка" 
                               FontSize="16" FontAttributes="Bold"/>

                        <Grid ColumnDefinitions="*,*" RowDefinitions="*,*,*" RowSpacing="8">
                          
                            <Label Text="Доходы:" Grid.Row="0" Grid.Column="0"/>
                            <Label Text="{Binding Summary.TotalIncome, StringFormat='{0:C}'}" 
                                   Grid.Row="0" Grid.Column="1" 
                                   TextColor="#4CAF50" FontAttributes="Bold"/>

                            <Label Text="Расходы:" Grid.Row="1" Grid.Column="0"/>
                            <Label Text="{Binding Summary.TotalExpenses, StringFormat='{0:C}'}" 
                                   Grid.Row="1" Grid.Column="1" 
                                   TextColor="#F44336" FontAttributes="Bold"/>

                            
                            <Label Text="Баланс:" Grid.Row="2" Grid.Column="0"/>
                            <Label Text="{Binding Summary.Balance, StringFormat='{0:C}'}" 
                                   Grid.Row="2" Grid.Column="1" 
                                   FontAttributes="Bold"
                                   TextColor="{Binding Summary.Balance, Converter={StaticResource BalanceColorConverter}}"/>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <HorizontalStackLayout>
                    <Label Text=" Транзакции" 
                           FontSize="18" FontAttributes="Bold"
                           VerticalOptions="Center"/>

                    <Button Text=" Добавить"
                            Command="{Binding ToggleAddTransactionCommand}"
                            BackgroundColor="#2196F3"
                            TextColor="White"
                            FontSize="14"
                            CornerRadius="10"
                            Margin="10,0,0,0"
                            HeightRequest="40"
                            IsVisible="{Binding IsAddingTransaction, Converter={StaticResource InverseBooleanConverter}}"/>

                    <Button Text=" Скрыть"
                            Command="{Binding ToggleAddTransactionCommand}"
                            BackgroundColor="Black"
                            TextColor="White"
                            FontSize="14"
                            CornerRadius="10"
                            Margin="10,0,0,0"
                            HeightRequest="40"
                            IsVisible="{Binding IsAddingTransaction}"/>
                </HorizontalStackLayout>

                <Label Text="Нет транзакций" 
                       IsVisible="{Binding HasData, Converter={StaticResource InverseBooleanConverter}}"
                       HorizontalOptions="Center" VerticalOptions="Center"
                       FontSize="16" TextColor="Gray" Margin="0,50"/>

                <CollectionView ItemsSource="{Binding Transactions}"
                                IsVisible="{Binding HasData}"
                                SelectionMode="None">

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame BackgroundColor="Black" 
                                   Padding="15" CornerRadius="10"
                                   Margin="0,0,0,10"
                                   HasShadow="True">

                                <Grid ColumnDefinitions="*, Auto" RowDefinitions="*,*,*">
                                    <Label Text="{Binding Description}" 
                                           Grid.Row="0" Grid.Column="0"
                                           FontSize="14" FontAttributes="Bold"
                                           LineBreakMode="TailTruncation"/>

                                    <Label Text="{Binding Amount, StringFormat='{0:C}'}" 
                                           Grid.Row="0" Grid.Column="1"
                                           FontSize="16" FontAttributes="Bold"
                                           TextColor="{Binding Type, Converter={StaticResource TransactionTypeColorConverter}}"/>

                                    <Label Text="{Binding CategoryName}" 
                                           Grid.Row="1" Grid.Column="0"
                                           FontSize="12" TextColor="Gray"/>

                                    <Label Text="{Binding AccountName}" 
                                           Grid.Row="2" Grid.Column="0"
                                           FontSize="12" TextColor="Gray"/>

                                    <Label Text="{Binding Date, StringFormat='{0:dd.MM.yyyy HH:mm}'}" 
                                           Grid.Row="1" Grid.Column="1"
                                           FontSize="12" TextColor="Gray"/>

                                    <Button Text="удалить" 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteTransactionCommand}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="Transparent"
                                            TextColor="#F44336"
                                            FontSize="16"
                                            Grid.Row="2" Grid.Column="1"/>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>


                <Button Text=" Обновить" 
                        Command="{Binding RefreshCommand}"
                        BackgroundColor="Black"
                        TextColor="White"
                        CornerRadius="10"
                        HeightRequest="40"
                        IsEnabled="{Binding IsNotBusy}"/>

            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>

</ContentPage>