<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:ClientPersonalFinance.Converters"
             x:Class="ClientPersonalFinance.Views.TransactionsPage"
             Title="–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏">

    <ContentPage.Resources>
        <converters:BalanceColorConverter x:Key="BalanceColorConverter" />
        <converters:TransactionTypeColorConverter x:Key="TransactionTypeColorConverter" />
        <converters:NotNullConverter x:Key="NotNullConverter" />
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter" />
    </ContentPage.Resources>

    <RefreshView IsRefreshing="{Binding IsBusy}"
                 Command="{Binding RefreshCommand}">

        <ScrollView>
            <VerticalStackLayout Spacing="20" Padding="20">

                <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
                <Frame IsVisible="{Binding IsAddingTransaction}"
                       BackgroundColor="#E8F5E9"
                       BorderColor="#4CAF50"
                       Padding="15"
                       CornerRadius="10">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="‚ûï –ù–æ–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è" 
                               FontSize="16" 
                               FontAttributes="Bold"
                               TextColor="#2E7D32"/>

                        <!-- –°—É–º–º–∞ -->
                        <VerticalStackLayout Spacing="5">
                            <Label Text="–°—É–º–º–∞ *" 
                                   FontSize="14"/>
                            <Entry Text="{Binding NewTransaction.Amount}"
                                   Placeholder="0.00"
                                   Keyboard="Numeric"/>
                        </VerticalStackLayout>

                        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                        <VerticalStackLayout Spacing="5">
                            <Label Text="–û–ø–∏—Å–∞–Ω–∏–µ *" 
                                   FontSize="14"/>
                            <Entry Text="{Binding NewTransaction.Description}"
                                   Placeholder="–ù–∞ —á—Ç–æ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏/–ø–æ–ª—É—á–∏–ª–∏"
                                   MaxLength="200"/>
                        </VerticalStackLayout>

                        <!-- –î–∞—Ç–∞ -->
                        <VerticalStackLayout Spacing="5">
                            <Label Text="–î–∞—Ç–∞" 
                                   FontSize="14"/>
                            <DatePicker Date="{Binding NewTransaction.Date}"
                                        Format="dd.MM.yyyy"/>
                        </VerticalStackLayout>

                        <!-- –¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
                        <VerticalStackLayout Spacing="5">
                            <Label Text="–¢–∏–ø *" 
                                   FontSize="14"/>
                            <Picker Title="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø"
                                    SelectedIndex="{Binding SelectedTransactionType}">
                                <Picker.Items>
                                    <x:String>–î–æ—Ö–æ–¥</x:String>
                                    <x:String>–†–∞—Å—Ö–æ–¥</x:String>
                                </Picker.Items>
                            </Picker>
                        </VerticalStackLayout>

                        <!-- –°—á–µ—Ç -->
                        <VerticalStackLayout Spacing="5">
                            <Label Text="–°—á–µ—Ç *" 
                                   FontSize="14"/>
                            <Picker Title="–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç"
                                    ItemsSource="{Binding Accounts}"
                                    ItemDisplayBinding="{Binding Name}"
                                    SelectedItem="{Binding SelectedAccount}"/>
                        </VerticalStackLayout>

                        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                        <VerticalStackLayout Spacing="5">
                            <Label Text="–ö–∞—Ç–µ–≥–æ—Ä–∏—è *" 
                                   FontSize="14"/>
                            <Picker Title="–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é"
                                    ItemsSource="{Binding FilteredCategories}"
                                    ItemDisplayBinding="{Binding Name}"
                                    SelectedItem="{Binding SelectedCategory}"/>
                        </VerticalStackLayout>

                        <!-- –ö–Ω–æ–ø–∫–∏ —Ñ–æ—Ä–º—ã -->
                        <HorizontalStackLayout Spacing="10" HorizontalOptions="Center">
                            <Button Text="‚úÖ –î–æ–±–∞–≤–∏—Ç—å"
                                    Command="{Binding AddTransactionCommand}"
                                    BackgroundColor="#4CAF50"
                                    TextColor="White"
                                    CornerRadius="10"
                                    WidthRequest="120"
                                    IsEnabled="{Binding IsNotBusy}"/>

                            <Button Text="‚ùå –û—Ç–º–µ–Ω–∞"
                                    Command="{Binding CancelAddTransactionCommand}"
                                    BackgroundColor="#F44336"
                                    TextColor="White"
                                    CornerRadius="10"
                                    WidthRequest="120"/>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Frame>

                <!-- –°—Ç–∞—Ç—É—Å -->
                <Label Text="{Binding StatusMessage}"
                       FontSize="14"
                       TextColor="Gray"
                       HorizontalOptions="Center"/>

                <!-- –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ -->
                <Frame IsVisible="{Binding Summary, Converter={StaticResource NotNullConverter}}"
                       BackgroundColor="#F5F5F5" Padding="15" CornerRadius="10">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="üìä –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞" 
                               FontSize="16" FontAttributes="Bold"/>

                        <Grid ColumnDefinitions="*,*" RowDefinitions="*,*,*" RowSpacing="8">
                            <!-- –î–æ—Ö–æ–¥—ã -->
                            <Label Text="–î–æ—Ö–æ–¥—ã:" Grid.Row="0" Grid.Column="0"/>
                            <Label Text="{Binding Summary.TotalIncome, StringFormat='{0:C}'}" 
                                   Grid.Row="0" Grid.Column="1" 
                                   TextColor="#4CAF50" FontAttributes="Bold"/>

                            <!-- –†–∞—Å—Ö–æ–¥—ã -->
                            <Label Text="–†–∞—Å—Ö–æ–¥—ã:" Grid.Row="1" Grid.Column="0"/>
                            <Label Text="{Binding Summary.TotalExpenses, StringFormat='{0:C}'}" 
                                   Grid.Row="1" Grid.Column="1" 
                                   TextColor="#F44336" FontAttributes="Bold"/>

                            <!-- –ë–∞–ª–∞–Ω—Å -->
                            <Label Text="–ë–∞–ª–∞–Ω—Å:" Grid.Row="2" Grid.Column="0"/>
                            <Label Text="{Binding Summary.Balance, StringFormat='{0:C}'}" 
                                   Grid.Row="2" Grid.Column="1" 
                                   FontAttributes="Bold"
                                   TextColor="{Binding Summary.Balance, Converter={StaticResource BalanceColorConverter}}"/>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
                <HorizontalStackLayout>
                    <Label Text="üìã –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏" 
                           FontSize="18" FontAttributes="Bold"
                           VerticalOptions="Center"/>

                    <Button Text="‚ûï –î–æ–±–∞–≤–∏—Ç—å"
                            Command="{Binding ToggleAddTransactionCommand}"
                            BackgroundColor="#2196F3"
                            TextColor="White"
                            FontSize="14"
                            CornerRadius="10"
                            Margin="10,0,0,0"
                            HeightRequest="40"
                            IsVisible="{Binding IsAddingTransaction, Converter={StaticResource InverseBooleanConverter}}"/>

                    <Button Text="‚ûñ –°–∫—Ä—ã—Ç—å"
                            Command="{Binding ToggleAddTransactionCommand}"
                            BackgroundColor="#FF9800"
                            TextColor="White"
                            FontSize="14"
                            CornerRadius="10"
                            Margin="10,0,0,0"
                            HeightRequest="40"
                            IsVisible="{Binding IsAddingTransaction}"/>
                </HorizontalStackLayout>

                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö -->
                <Label Text="–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π" 
                       IsVisible="{Binding HasData, Converter={StaticResource InverseBooleanConverter}}"
                       HorizontalOptions="Center" VerticalOptions="Center"
                       FontSize="16" TextColor="Gray" Margin="0,50"/>

                <!-- –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π -->
                <CollectionView ItemsSource="{Binding Transactions}"
                                IsVisible="{Binding HasData}"
                                SelectionMode="None">

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame BackgroundColor="White" 
                                   Padding="15" CornerRadius="10"
                                   Margin="0,0,0,10"
                                   HasShadow="True">

                                <Grid ColumnDefinitions="*, Auto" RowDefinitions="*,*,*">
                                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                                    <Label Text="{Binding Description}" 
                                           Grid.Row="0" Grid.Column="0"
                                           FontSize="14" FontAttributes="Bold"
                                           LineBreakMode="TailTruncation"/>

                                    <!-- –°—É–º–º–∞ -->
                                    <Label Text="{Binding Amount, StringFormat='{0:C}'}" 
                                           Grid.Row="0" Grid.Column="1"
                                           FontSize="16" FontAttributes="Bold"
                                           TextColor="{Binding Type, Converter={StaticResource TransactionTypeColorConverter}}"/>

                                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏ —Å—á–µ—Ç -->
                                    <Label Text="{Binding CategoryName}" 
                                           Grid.Row="1" Grid.Column="0"
                                           FontSize="12" TextColor="Gray"/>

                                    <Label Text="{Binding AccountName}" 
                                           Grid.Row="2" Grid.Column="0"
                                           FontSize="12" TextColor="Gray"/>

                                    <!-- –î–∞—Ç–∞ -->
                                    <Label Text="{Binding Date, StringFormat='{0:dd.MM.yyyy HH:mm}'}" 
                                           Grid.Row="1" Grid.Column="1"
                                           FontSize="12" TextColor="Gray"/>

                                    <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
                                    <Button Text="üóëÔ∏è" 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteTransactionCommand}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="Transparent"
                                            TextColor="#F44336"
                                            FontSize="16"
                                            Grid.Row="2" Grid.Column="1"/>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
                <Button Text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å" 
                        Command="{Binding RefreshCommand}"
                        BackgroundColor="#2196F3"
                        TextColor="White"
                        CornerRadius="10"
                        HeightRequest="40"
                        IsEnabled="{Binding IsNotBusy}"/>

            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>

</ContentPage>